<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Team Sync</title>
    <style>
        body{font-family:Arial;max-width:600px;margin:20px auto;padding:15px;background:#f5f5f5}
        .container{background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        h1{text-align:center;margin:0 0 20px;color:#333;font-size:22px}
        .q{margin-bottom:12px}
        .q label{display:block;font-weight:bold;margin-bottom:4px;color:#444;font-size:13px}
        .q textarea{width:100%;height:40px;padding:6px;border:1px solid #ddd;border-radius:3px;font:12px Arial;resize:vertical;box-sizing:border-box}
        .q textarea:focus{border-color:#4CAF50;outline:none}
        .btn{background:#4CAF50;color:white;padding:10px 20px;border:none;border-radius:3px;font:bold 13px Arial;cursor:pointer;display:block;margin:15px auto 0}
        .btn:hover{background:#45a049}
        .success{background:#d4edda;color:#155724;padding:10px;border-radius:3px;margin-bottom:15px;text-align:center;font-size:13px}
        .qotw{background:#e7f3ff;color:#0c5aa6;padding:12px;border-radius:3px;margin-bottom:15px;border-left:4px solid #0c5aa6}
        .qotw strong{display:block;margin-bottom:5px;font-size:13px}
    </style>
    <script>
        // Only shutdown server when browser tab/window is closed AFTER successful submission
        var formSubmittedSuccessfully = {% if success %}true{% else %}false{% endif %};
        
        if (formSubmittedSuccessfully) {
            // Only add close detection after successful submission
            window.addEventListener('beforeunload', function() {
                navigator.sendBeacon('/shutdown');
            });
            
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    setTimeout(function() {
                        if (document.visibilityState === 'hidden') {
                            fetch('/shutdown', {method: 'POST', keepalive: true}).catch(function() {});
                        }
                    }, 2000);
                }
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Weekly Team Sync</h1>
        {% if success %}
            <div class="success">✅ Responses submitted successfully! You can close this tab.</div>
        {% elif empty_submission %}
            <div style="background:#fff3cd;color:#856404;padding:10px;border-radius:3px;margin-bottom:15px;text-align:center;font-size:13px">
                ⚠️ No responses provided. Please fill out at least one field before submitting.
            </div>
            {% if qotw %}
                <div class="qotw">
                    <strong>Question of the Week:</strong>
                    {{ qotw }}
                </div>
            {% endif %}
            <form method="POST">
                {% for question in questions %}
                    <div class="q">
                        <label>{{ loop.index }}. {{ question }}</label>
                        <textarea name="question_{{ loop.index0 }}" placeholder="Your response..." tabindex="{{ loop.index }}"></textarea>
                    </div>
                {% endfor %}
                <button type="submit" class="btn" tabindex="{{ questions|length + 1 }}">Submit</button>
            </form>
        {% else %}
            {% if qotw %}
                <div class="qotw">
                    <strong>Question of the Week:</strong>
                    {{ qotw }}
                </div>
            {% endif %}
            <form method="POST">
                {% for question in questions %}
                    <div class="q">
                        <label>{{ loop.index }}. {{ question }}</label>
                        <textarea name="question_{{ loop.index0 }}" placeholder="Your response..." tabindex="{{ loop.index }}"></textarea>
                    </div>
                {% endfor %}
                <button type="submit" class="btn" tabindex="{{ questions|length + 1 }}">Submit</button>
            </form>
        {% endif %}
    </div>
</body>
</html>